<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image Review Interface</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="/favicon.ico" />
  <style>    
    .fixed-left {
        position: fixed;
        top: 0;
        left: 0;
        width: 50vw;
        height: 100vh;
        padding: 1rem 0;
        box-sizing: border-box;
        overflow: hidden;
        margin: 0;
        padding: 0;
    }

    .fixed-left a {
        /* make the link fill the panel so the img can absolutely center */
        position: relative;
        display: block;
        width: 100%;
        height: 100%;
    }

    .fixed-left img {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);

        /* never exceed your panel’s size: */
        max-width: 100%;
        max-height: 100%;
        
        /* optional niceties: */
        object-fit: contain;
        border-radius: 0.25rem;
        border: 1px solid #ddd;
    }
    .content-right {
      margin-left: 50%;
      padding: 15rem 1rem 1rem 1rem;
      margin-top: -4rem;
    }
  </style>
</head>
<body class="bg-white-100">
  <!-- Fixed Image Panel -->
  <div class="fixed-left py-4 box-border">
    <a id="imageLink" href="#" target="_blank">
      <img id="image" src="" alt="Review Image">
    </a>
  </div>

  <!-- Right Side Content -->
  <div class="content-right max-w-3xl">
    <div class="space-y-4">
      <div id="imageInfo" class="space-y-4 mb-8">
      </div>
      
      <div id="depictFields" class="space-y-2">
        <label class="block text-2xl font-medium text-black-700">Depicts:</label>
        <input type="text" class="depict-input w-full border text-2xl p-2 rounded" />
      </div>
      <button onclick="addDepictField()" class="text-blue-600 text-2xl">+ Add depicts field</button>

      <div>
        <label class="block text-2xl font-medium mb-2 text-black-700">Comments:</label>
        <textarea id="comments" class="w-full border text-2xl p-2 rounded mb-4" rows="3"></textarea>
      </div>

      <button onclick="submitReview()" class="bg-green-600 text-white text-2xl px-4 py-2 rounded hover:bg-green-700">Submit</button>

      <div class="flex justify-between pt-4">
        <button onclick="prevImage()" class="bg-blue-600 text-white text-2xl px-4 py-2 rounded hover:bg-blue-700">&larr; Previous</button>
        <button onclick="nextImage()" class="bg-blue-600 text-white text-2xl px-4 py-2 rounded hover:bg-blue-700">Next &rarr;</button>
      </div>
    </div>
  </div>

  <script type="text/javascript">
    let images = [];
    let currentIndex = 0;

    fetch('image_depict_url.json')
        .then(response => response.json())
        .then(data => {
            images = data;
            render(); 
        })
        .catch(err => {
            console.error("Failed to load image data:", err);
        });

    function render() {
        if (!images || images.length === 0) {
            console.warn("No image data available.");
            return;
        }

        if (currentIndex < 0 || currentIndex >= images.length) {
            console.error("Invalid currentIndex:", currentIndex);
            return;
        }

        const imageData = images[currentIndex];

        if (!imageData.url) {
            console.warn("Missing 'url' for image at index", currentIndex);
            return;
        }
        const url = imageData.url;
        const page_url = imageData.page_url;
        const title = imageData.fname_scrape;
        const fname_commons = imageData.fname_commons;

        // Set image source and link
        document.getElementById('image').src = url;
        document.getElementById('imageLink').href = page_url;

        // populate title + filename
        const info = document.getElementById('imageInfo');
        info.textContent = '';          // clear it out

        // Title
        const titleEl = document.createElement('p');
        titleEl.className = 'text-2xl text-black';
        const titleLabel = document.createElement('span');
        titleLabel.className = 'font-bold';
        titleLabel.textContent = 'Title: ';
        const titleValue = document.createElement('span');
        titleValue.className = 'font-normal';
        titleValue.textContent = imageData.fname_scrape || 'Untitled';
        titleEl.appendChild(titleLabel);
        titleEl.appendChild(titleValue);
        info.appendChild(titleEl);

        // File name with link
        const fileEl = document.createElement('p');
        fileEl.className = 'text-2xl text-black-500';
        const fileLabel = document.createElement('span');
        fileLabel.className = 'font-bold';
        fileLabel.textContent = 'File Name: ';
        fileEl.appendChild(fileLabel);

        const fileLink = document.createElement('a');
        fileLink.href = imageData.page_url;
        fileLink.textContent = imageData.fname_commons || 'no-file.jpg';
        fileLink.target = '_blank';
        fileLink.rel = 'noopener noreferrer';
        fileLink.className = 'font-normal underline';  // optional styling
        fileEl.appendChild(fileLink);

        info.appendChild(fileEl);

        // Clear and populate depict fields container
        const container = document.getElementById('depictFields');
        container.innerHTML = '';

        // Depict Level 1 wrapper
        const group1 = document.createElement('div');
        group1.className = 'mb-6';

        const label1 = document.createElement('label');
        label1.className = 'block font-medium text-2xl text-black mb-2';
        label1.textContent = 'Depict L1:';
        group1.appendChild(label1);

        const input1 = document.createElement('input');
        input1.className = 'depict-input w-full border text-2xl p-2 rounded';
        input1.value = imageData.depict_l1 || '';
        input1.dataset.depictLevel = '1';
        group1.appendChild(input1);

        container.appendChild(group1);

        // Depict Level 2 wrapper
        const group2 = document.createElement('div');

        const label2 = document.createElement('label');
        label2.className = 'block font-medium text-2xl text-black mb-2';
        label2.textContent = 'Depict L2:';
        group2.appendChild(label2);

        const input2 = document.createElement('input');
        input2.className = 'depict-input w-full border text-2xl p-2 rounded';
        input2.value = imageData.depict_l2 || '';
        input2.dataset.depictLevel = '2';
        group2.appendChild(input2);

        container.appendChild(group2);
    }

    function addDepictField() {
        const container = document.getElementById('depictFields');
        const wrapper = document.createElement('div');
        wrapper.className = 'flex items-center gap-2 mb-2';

        const input = document.createElement('input');
        input.className = 'depict-input w-full border text-2xl p-2 rounded';
        wrapper.appendChild(input);

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'text-red-600 text-xl px-3 py-1 border border-red-600 rounded hover:bg-red-100';
        deleteBtn.textContent = 'Delete';
        deleteBtn.onclick = () => wrapper.remove();
        wrapper.appendChild(deleteBtn);

        container.appendChild(wrapper);
    }

    // where to collect the result?
    function submitReview() {
      const inputs = document.querySelectorAll('.depict-input');
      const comments = document.getElementById('comments').value;
      const data = {
        timestamp: new Date().toISOString(),
        image: images[currentIndex].fname_commons,
        comment: comments,
        depicts: Array.from(inputs).map(i => i.value)

      };
      console.log('Submitted Review:', data);

      // For now, append to localStorage
      // const prev = JSON.parse(localStorage.getItem('reviews') || '[]');
      // prev.push(data);
      // localStorage.setItem('reviews', JSON.stringify(prev));

      // alert('Review saved!');
      // document.getElementById('comments').value = '';

      fetch('/api/reviews', {
        method:  'POST',
        headers: { 'Content-Type': 'application/json' },
        body:    JSON.stringify(data)
      })
      .then(async resp => {
        // parse whatever JSON we get back (or {} if it’s not JSON)
        const body = await resp.json().catch(() => ({}));

        if (body.status === 'ok') {
          alert('✅ Review saved to server!');
          document.getElementById('comments').value = '';
        } else {
          // show the exact error message our server sent
          alert(`❌ Server error:\n${body.message}`);
        }
      })
      .catch(err => {
        console.error('Network error:', err);
        alert('⚠️ Could not send review');
      });
    }

    // add one more option for loading the last-submitted response in case the reviewer wanna go back to modify it 


    function nextImage() {
      if (currentIndex < images.length - 1) {
        currentIndex++;
        render();
      } else {
        alert('No more images.');
      }
    }

    function prevImage() {
      if (currentIndex > 0) {
        currentIndex--;
        render();
      }
    }

    // Initial render
    render();
  </script>
</body>
</html>
